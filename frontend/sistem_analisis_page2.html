<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analisis Gejala TBC - Epicare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="./style/style.css">

    <style>
      body {
        background: linear-gradient(to right, #0a996a, #0e3f2c);
      }
      .glass {
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body class="text-white font-sans">

    <div id="navbar-placeholder"></div>
    <script>
      fetch('./navbar.html')
        .then(response => response.text())
        .then(data => {
          document.getElementById('navbar-placeholder').innerHTML = data;

          // Tambahkan event listener setelah navbar dimuat
          const profileIcon = document.getElementById('profile-icon');
          const dropdownMenu = document.getElementById('dropdown-menu');

          if (profileIcon && dropdownMenu) {
            profileIcon.addEventListener('click', () => {
              dropdownMenu.classList.toggle('hidden');
            });

            // Optional: tutup dropdown saat klik di luar
            document.addEventListener('click', (e) => {
              if (!profileIcon.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.add('hidden');
              }
            });
          }
        })
        .catch(error => console.error('Error loading navbar:', error));
    </script>

    <!-- Main Content -->
    <main class="px-8 max-w-7xl mx-auto mt-24">
      <section class="text-center mb-5">
        <h1 class="text-4xl font-bold tracking-wide">Analisis Gejala TBC</h1>
        <p class="text-lg mt-2 text-gray-200">Sistem deteksi dini TBC berbasis gejala menggunakan Machine Learning</p>
      </section>

      <form class="grid md:grid-cols-2 gap-8 text-center items-center">
        <!-- Card 1 -->
        <div>
          <div class="glass p-6 rounded-2xl shadow-md space-y-6">
            <!-- Q1 -->
            <div>
              <label class="block font-semibold mb-1 text-lg text-white">Q11. Apakah Anda mudah tersinggung akhir-akhir ini?</label>
              <div class="flex gap-6 text-base justify-center">
                <label><input type="radio" name="q11" value="0" class="mr-1 accent-[#0a996a]" /> Tidak/Ringan</label>
                <label><input type="radio" name="q11" value="1" class="mr-1 accent-[#0a996a]" /> Sedang</label>
                <label><input type="radio" name="q11" value="2" class="mr-1 accent-[#0a996a]" /> Parah</label>
              </div>
              <hr class="border-gray-400 mt-3" />
            </div>

            <!-- Q2 -->
            <div>
              <label class="block font-semibold mb-1 text-lg text-white">Q12. Apakah Anda kehilangan nafsu makan?</label>
              <div class="flex gap-6 text-base justify-center">
                <label><input type="radio" name="q12" value="0" class="mr-1 accent-[#0a996a]" /> Tidak/Ringan</label>
                <label><input type="radio" name="q12" value="1" class="mr-1 accent-[#0a996a]" /> Sedang</label>
                <label><input type="radio" name="q12" value="2" class="mr-1 accent-[#0a996a]" /> Parah</label>
              </div>
              <hr class="border-gray-400 mt-3" />
            </div>

            <!-- Q3 -->
            <div>
              <label class="block font-semibold mb-1 text-lg text-white">Q13. Apakah Anda merasa kekurangan energi?</label>
              <div class="flex gap-6 text-base justify-center">
                <label><input type="radio" name="q13" value="0" class="mr-1 accent-[#0a996a]" /> Tidak/Ringan</label>
                <label><input type="radio" name="q13" value="1" class="mr-1 accent-[#0a996a]" /> Sedang</label>
                <label><input type="radio" name="q13" value="2" class="mr-1 accent-[#0a996a]" /> Parah</label>
              </div>
              <hr class="border-gray-400 mt-3" />
            </div>

            <!-- Q4 -->
            <div>
              <label class="block font-semibold mb-1 text-lg text-white">Q14. Apakah Anda mengalami pembesaran kelenjar getah bening?</label>
              <div class="flex gap-6 text-base justify-center">
                <label><input type="radio" name="q14" value="0" class="mr-1 accent-[#0a996a]" /> Tidak/Ringan</label>
                <label><input type="radio" name="q14" value="1" class="mr-1 accent-[#0a996a]" /> Sedang</label>
                <label><input type="radio" name="q14" value="2" class="mr-1 accent-[#0a996a]" /> Parah</label>
              </div>
              <hr class="border-gray-400 mt-3" />
            </div>
          </div>

          <!-- Tombol Prev & Next -->
          <div class="flex justify-center gap-4 my-6">
            <a href="./sistem_analisis.html" class="bg-[#192824] hover:bg-[#0e3f2c] transition text-white px-8 py-2 rounded-xl shadow-md text-lg border-white border-2">Prev</a>
          </div>
        </div>

        <!-- Card 2 -->
        <div>
          <div class="glass p-6 rounded-2xl shadow-md space-y-6">
            <!-- Q6 -->
            <div>
              <label class="block font-semibold mb-1 text-lg text-white">Q15. Apakah tekanan darah sistolik Anda tinggi?</label>
              <div class="flex gap-6 text-base justify-center">
                <label><input type="radio" name="q15" value="0" class="mr-1 accent-[#0a996a]" /> Tidak/Ringan</label>
                <label><input type="radio" name="q15" value="1" class="mr-1 accent-[#0a996a]" /> Sedang</label>
                <label><input type="radio" name="q15" value="2" class="mr-1 accent-[#0a996a]" /> Parah</label>
              </div>
              <hr class="border-gray-400 mt-3" />
            </div>

            <!-- Q7 -->
            <div>
              <label class="block font-semibold mb-1 text-lg text-white">Q16. Apakah berat badan Anda ideal?</label>
              <div class="flex gap-6 text-base justify-center">
                <label><input type="radio" name="q16" value="0" class="mr-1 accent-[#0a996a]" /> Tidak/Ringan</label>
                <label><input type="radio" name="q16" value="1" class="mr-1 accent-[#0a996a]" /> Sedang</label>
                <label><input type="radio" name="q16" value="2" class="mr-1 accent-[#0a996a]" /> Parah</label>
              </div>
              <hr class="border-gray-400 mt-3" />
            </div>
          </div>

          <div class="flex justify-center mt-6">
            <button type="button" id="predict-btn" class="bg-[#192824] hover:bg-[#0e3f2c] transition text-white px-8 py-2 rounded-xl shadow-md text-lg border-white border-2">Prediksi</button>
          </div>

          <!-- Output Prediksi -->
          <div id="prediction-result" class="hidden mt-4 px-6 py-4 bg-[#192824] rounded-xl shadow-md text-white text-center border-2 border-white"></div>
          <!-- Loading Spinner -->
          <div id="loading-spinner" class="mt-6 hidden justify-center">
            <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-white border-opacity-50"></div>
          </div>
      </form>

      <!-- TARUH DI LUAR <form> ATAU SETELAH TAG </form> -->
<div class="flex justify-center my-6">
  <button type="button" onclick="resetAndBack()" class="bg-[#192824] hover:bg-[#0e3f2c] transition text-white px-6 py-2 rounded-xl shadow-md border-white border-2">
    üîÅ Reset & Kembali ke Awal
  </button>
</div>

</main>

<!-- Popup for validation -->
<div id="popup-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
  <div id="popup" class="bg-[#192824] p-6 rounded-xl shadow-lg text-white max-w-sm text-center">
    Mohon isi semua pertanyaan sebelum melanjutkan.
    <br />
    <button id="popup-close-btn" class="mt-4 bg-[#0a996a] hover:bg-[#0e3f2c] px-4 py-2 rounded-lg font-semibold">Tutup</button>
  </div>
</div>

<script>
  function resetAndBack() {
    localStorage.clear(); // Bersihkan semua data lokal
    window.location.href = './sistem_analisis.html'; // Redirect ke page pertama
  }

  const formDataPage1 = JSON.parse(localStorage.getItem('formData')) || {};

  // Restore saved selections from localStorage on page load
  document.addEventListener('DOMContentLoaded', () => {
    const savedData = JSON.parse(localStorage.getItem('formDataPage2')) || {};
    Object.keys(savedData).forEach(key => {
      const value = savedData[key];
      if (value !== null) {
        const radio = document.querySelector(`input[name="${key}"][value="${value}"]`);
        if (radio) {
          radio.checked = true;
        }
      }
    });
  });

  // Save form data to localStorage on change
  const inputs = document.querySelectorAll('input[type="radio"]');
  inputs.forEach(input => {
    input.addEventListener('change', () => {
      const formData = {};
      ['q11', 'q12', 'q13', 'q14', 'q15', 'q16'].forEach(q => {
        formData[q] = document.querySelector(`input[name="${q}"]:checked`)?.value || null;
      });
      localStorage.setItem('formDataPage2', JSON.stringify(formData));
    });
  });

  function collectFormDataPage2() {
    const formData = {};
    formData.q11 = document.querySelector('input[name="q11"]:checked')?.value || null;
    formData.q12 = document.querySelector('input[name="q12"]:checked')?.value || null;
    formData.q13 = document.querySelector('input[name="q13"]:checked')?.value || null;
    formData.q14 = document.querySelector('input[name="q14"]:checked')?.value || null;
    formData.q15 = document.querySelector('input[name="q15"]:checked')?.value || null;
    formData.q16 = document.querySelector('input[name="q16"]:checked')?.value || null;
    return formData;
  }

  async function sendDataToAPI() {
    // Validate all questions answered
    const formData = collectFormDataPage2();
    const allAnswered = Object.values(formData).every(value => value !== null);
    if (!allAnswered) {
      // Show popup
      document.getElementById('popup-overlay').classList.remove('hidden');
      return;
    }

    const finalData = { ...formDataPage1, ...formData };

    const dataToSend = [
      finalData.q1, finalData.q2, finalData.q3, finalData.q4,
      finalData.q5, finalData.q6, finalData.q7, finalData.q8,
      finalData.q9, finalData.q10, finalData.q11, finalData.q12,
      finalData.q13, finalData.q14, finalData.q15, finalData.q16
    ];

    const numericData = dataToSend.map(value => parseInt(value, 10));
    console.log("Data yang dikirim ke API:", numericData);

    const spinner = document.getElementById('loading-spinner');
    const predictionElement = document.getElementById('prediction-result');
    spinner.classList.remove('hidden');
    predictionElement.innerHTML = ""; // Kosongkan sementara

    try {
      const response = await fetch('http://127.0.0.1:8000/predict/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(dataToSend)
      });

      const result = await response.json();
      console.log("Response from API:", result);
      displayPredictionResult(result);
    } catch (error) {
      console.error("Error sending data to API:", error);
      predictionElement.innerHTML = `<p class="text-red-500">‚ùå Terjadi kesalahan. Silakan coba lagi.</p>`;
    } finally {
      spinner.classList.add('hidden'); // Sembunyikan spinner apapun hasilnya
    }
  }

  function displayPredictionResult(result) {
    const predictionElement = document.getElementById('prediction-result');
    predictionElement.classList.remove('hidden'); // Tampilkan kotak hasil

    let percentage = parseFloat(result.prediction);
    let message = '';

    if (percentage < 30) {
  message = 'Risiko terdeteksi rendah. Tetap jaga pola hidup sehat dan kebersihan.';
    } else if (percentage < 60) {
      message = 'Risiko sedang terdeteksi. Sebaiknya lakukan pemeriksaan medis lebih lanjut.';
    } else {
      message = 'Risiko tinggi terdeteksi. Segera lakukan konsultasi dengan dokter atau fasilitas kesehatan terdekat.';
    }


    predictionElement.innerHTML = `
      <p class="text-sm mb-2">üîç <strong>Hasil Anda :</strong></p>
      <p class="text-4xl font-bold mb-2">${percentage}%</p>
      <p class="text-base">${message}</p>
    `;
  }

  document.getElementById('predict-btn').addEventListener('click', sendDataToAPI);

  // Close popup button
  document.getElementById('popup-close-btn').addEventListener('click', () => {
    document.getElementById('popup-overlay').classList.add('hidden');
  });
</script>
  </body>
</html>
