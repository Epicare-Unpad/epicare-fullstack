<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot - Epicare</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
      body {
        background: linear-gradient(to right, #0a996a, #0e3f2c);
        margin: 0;
        padding: 0;
      }

      .glass {
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Scrollbar Styling */
      .custom-scrollbar::-webkit-scrollbar {
        width: 8px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        border: 2px solid transparent;
        background-clip: content-box;
      }

      #chat-scroll-container {
  height: calc(76vh - 12rem); /* Sesuaikan tinggi chat area untuk memberi ruang pada input sticky */
  overflow-y: auto;
}
#chat-scroll-container::-webkit-scrollbar {
  display: none; /* Chrome, Safari */
}

nav {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 50; /* Menjaga navbar di atas */
  backdrop-filter: blur(10px);
  background: rgba(1, 191, 129, 0.8);
  padding: 1rem 2rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: all 0.3s ease;
}


nav .nav-link {
  @apply text-white hover:text-emerald-200 transition duration-300 font-bold;
  font-size: 20px;
  font-weight: 500;
}

nav .nav-link:hover {
  transform: translateY(-2px);
}

nav .nav-link::after {
  content: '';
  display: block;
  width: 0%;
  height: 2px;
  background: white;
  transition: width 0.3s;
}

nav .nav-link:hover::after {
  width: 100%;
}

      .content {
        margin-left: 272px; /* Menyesuaikan sidebar width (64px + padding) */
        margin-right: 24px;
        margin-top: 160px; /* Cukupkan jarak atas agar konten tidak tertutup */
        position: relative;
        z-index: 10;
      }



      .prose-invert a {
        color: #a5f3fc;
        text-decoration: underline;
      }
      .prose-invert strong {
        color: white;
        font-weight: 600;
      }
      .prose-invert em {
        color: #d1fae5;
        font-style: italic;
      }
      .prose-invert code {
        background: rgba(0,0,0,0.2);
        padding: 0.2em 0.4em;
        border-radius: 0.25em;
        font-family: monospace;
      }
      .prose-invert pre {
        background: rgba(0,0,0,0.3);
        padding: 1em;
        border-radius: 0.5em;
        overflow-x: auto;
      }
      .prose-invert ul {
        list-style-type: disc;
        padding-left: 1.5em;
      }
      .prose-invert ol {
        list-style-type: decimal;
        padding-left: 1.5em;
      }
      .prose-invert blockquote {
        border-left: 3px solid #10b981;
        padding-left: 1em;
        margin-left: 0;
        color: #d1fae5;
      }
      .prose-invert h1, 
      .prose-invert h2, 
      .prose-invert h3 {
        color: white;
        font-weight: 600;
        margin-top: 1em;
        margin-bottom: 0.5em;
      }

      /* Typing Animation */
      .dot-typing {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 8px;
        height: 24px;
        padding: 10px 0;
      }
      .dot-typing span {
        width: 8px;
        height: 8px;
        background-color: white;
        border-radius: 50%;
        display: inline-block;
        animation: dotBounce 1.2s infinite ease-in-out;
      }
      .dot-typing span:nth-child(1) {
        animation-delay: 0s;
      }
      .dot-typing span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .dot-typing span:nth-child(3) {
        animation-delay: 0.4s;
      }
      @keyframes dotBounce {
        0%, 80%, 100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-8px);
        }
      }

    </style>
  </head>
  <body class="text-white min-h-screen font-sans overflow-hidden">
    <!-- Navbar -->
    <nav class="fixed w-full top-0 z-50 bg-[#01BF81]/80 backdrop-blur-md border-b border-white/20 shadow-lg">
      <div class="max-w-7xl mx-auto px-6 flex items-center justify-between">
        <!-- Logo -->
        <a href="#" class="flex items-center space-x-3">
          <img src="./img/epicare-logo.png" alt="Logo" class="w-10 h-10" />
          <span class="text-2xl font-bold text-white">Epicare</span>
        </a>
    
        <!-- Navigation Links -->
        <div class="flex items-center space-x-8">
          <a href="./article-list.html" class="nav-link">Artikel Kesehatan</a>
          <a href="./sistem_analisis.html" class="nav-link">Sistem Analisis Gejala</a>
          <a href="./chatbot.html" class="nav-link">Chatbot</a>
        </div>
    
        <!-- Profile Icon -->
        <a href="#" class="w-10 h-10 rounded-full overflow-hidden border-2 border-white hover:scale-105 transition duration-300">
          <img src="./img/profile.png" alt="Profile" class="w-full h-full object-cover" />
        </a>
      </div>
    </nav>
    
    <!-- SIDEBAR -->
    <div class="fixed top-16 left-0 w-64 h-[calc(100vh-4rem)] bg-[#003f2b] border-r border-white/10 shadow-lg z-40 flex flex-col">
      <div class="p-6 border-b border-white/10">
        <h2 class="text-xl font-bold text-white">Riwayat Chat</h2>
        <button id="new-chat-btn" class="mt-4 bg-emerald-500 hover:bg-emerald-600 text-white py-2 px-4 rounded-md w-full">
          + Chat Baru
        </button>
      </div>
      <div id="chat-history" class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-2">
        <!-- Chat history akan ditambahkan di sini -->
      </div>
    </div>

    <!-- MAIN -->
    <div class="content ml-64 mr-6 flex flex-col h-screen p-6 space-y-6 mt-10">
      <!-- HEADER -->
      <div class="sticky top-20 bg-[#0e3f2c] z-20 p-2 rounded-xl border border-white/20 shadow-inner" style="margin-bottom: 10px;">
        <div class="flex items-center justify-between">
          <h1 class="text-2xl font-bold">Chatbot Epicare</h1>
          <span class="bg-white/10 border border-white/20 px-3 py-1 text-sm rounded-full font-medium shadow-inner">Versi Beta</span>
        </div>
        <p class="text-white/80 mt-2">
          Asisten virtual yang siap bantu kamu memahami gejala TBC dan penyakit pernapasan sejenis, secara cepat dan informatif.
        </p>
        <div class="mt-4 bg-white/10 p-4 rounded-3xl border border-white/20 shadow-inner">
          <p class="text-sm">
            <i class="fa-solid fa-circle-info mr-2 text-emerald-300"></i>
            Informasi yang diberikan bersifat edukatif dan tidak menggantikan diagnosis langsung dari tenaga medis profesional.
          </p>
        </div>
      </div>

      <!-- CHAT AREA -->
      <div class="flex-grow relative">
  <div class="space-y-6 pr-2 scroll-smooth" id="chat-scroll-container">

          <!-- Bot -->
          <div class="flex justify-start">
            <div class="max-w-[70%] bg-[#01bf80cb] border border-white/20 p-4 rounded-3xl rounded-bl-none text-[16px] font-semibold shadow-md">
              <p>Hai! Saya Epicare, asisten virtual kamu. Aku di sini buat bantu kamu memahami gejala TBC dan kasih arahan. Gimana kabarmu hari ini?</p>
            </div>
          </div>
        </div>
      </div>


      <!-- INPUT STICKY -->
      <div class="fixed bottom-6 bottom-11 left-64 max-w-[calc(100%-16rem-1.5rem)] w-[calc(100%-16rem-1.5rem)] z-40" style="box-sizing: border-box; padding-right: 1.5rem;">
        <div class="flex items-center gap-4 justify-center">
          <input 
            type="text" 
            placeholder="Ketik pertanyaanmu di sini..." 
            class="flex-grow max-w-[70%] px-4 py-3 rounded-md bg-white text-[#00885C] placeholder-[#00885C] focus:outline-none focus:ring-2 focus:ring-emerald-400 transition" 
          />
          <button class="bg-emerald-500 hover:bg-emerald-600 w-14 h-14 rounded-full flex items-center justify-center transition">
            <i class="fa-solid fa-paper-plane text-2xl text-white"></i>
          </button>
        </div>
      </div>
    </div>
    <script>
      const inputField = document.querySelector('input[type="text"]');
      const sendButton = document.querySelector('button');
      const chatContainer = document.getElementById('chat-scroll-container');

      function addChatBubble(text, from = 'user') {
        const bubble = document.createElement('div');
        bubble.className = `flex justify-${from === 'user' ? 'end' : 'start'} mt-4`;

        const innerBubble = document.createElement('div');
        innerBubble.className = `max-w-[70%] ${
          from === 'user'
            ? 'bg-[#DBFFEF] text-[#00885C] border border-emerald-300/30 rounded-br-none'
            : 'bg-[#01BF81] border border-white/20 text-white rounded-bl-none'
        } p-4 rounded-3xl text-[16px] font-semibold shadow-md`;

        if (from === 'bot') {
          const markdownContainer = document.createElement('div');
          markdownContainer.className = 'prose prose-sm prose-invert max-w-none';
          markdownContainer.innerHTML = marked.parse(text);
          innerBubble.appendChild(markdownContainer);
        } else {
          innerBubble.innerHTML = `<p>${text}</p>`;
        }

        bubble.appendChild(innerBubble);
        chatContainer.appendChild(bubble);
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100);
      }

      function showLoading() {
        const loadingBubble = document.createElement('div');
        loadingBubble.className = 'flex justify-start mt-4';
        loadingBubble.id = 'loading-bubble';

        const bubbleContent = document.createElement('div');
        bubbleContent.className = 'max-w-[70%] bg-[#01BF81] border border-white/20 p-4 rounded-3xl rounded-bl-none text-[16px] font-semibold shadow-md text-white';
        
        const dotWrapper = document.createElement('div');
        dotWrapper.className = 'dot-typing';
        dotWrapper.innerHTML = '<span></span><span></span><span></span>';

        bubbleContent.appendChild(dotWrapper);
        loadingBubble.appendChild(bubbleContent);
        chatContainer.appendChild(loadingBubble);
        setTimeout(() => {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }, 100);
      }

      async function sendMessage() {
        const userInput = inputField.value.trim();
        if (!userInput) return;

        addChatBubble(userInput, 'user');
        inputField.value = '';
        showLoading();

        try {
          // If no current chat, create a new chat first
          if (!currentChatId) {
            const chatTitle = userInput.length > 20 ? userInput.substring(0, 20) + "..." : userInput;
            const createChatRes = await fetch('http://localhost:8000/chat_history/chats', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                user_id: userId,
                title: chatTitle
              })
            });
            if (!createChatRes.ok) throw new Error("Failed to create chat");
            const newChat = await createChatRes.json();
            currentChatId = newChat.id;
            fetchChatList(); // Refresh chat list sidebar
          }

          // Send user message to backend to save
          console.log("currentChatId before saving user message:", currentChatId);
          const saveUserMsgRes = await fetch('http://localhost:8000/chat_history/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: currentChatId,
              sender: 'user',
              content: userInput
            })
          });
          if (!saveUserMsgRes.ok) throw new Error("Failed to save user message");

          // Send user input to chatbot API
          const res = await fetch('http://localhost:8000/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              user_input: `Kamu adalah chatbot medis yang hanya dapat memberikan informasi tentang Tuberkulosis (TBC) dan penyakit serupa. Jika pertanyaan tidak terkait dengan TBC atau penyakit terkait, tetapi masih lingkup penyakit, jawab saja. Jika tidak, beri tahu pengguna bahwa kamu hanya dapat memberikan informasi tentang topik tersebut. Pertanyaan: ${userInput}`
            })
          });

          const data = await res.json();
          document.getElementById('loading-bubble')?.remove();
          addChatBubble(data.reply, 'bot');

          // Save chatbot response message
          const saveBotMsgRes = await fetch('http://localhost:8000/chat_history/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              chat_id: currentChatId,
              sender: 'bot',
              content: data.reply
            })
          });
          if (!saveBotMsgRes.ok) console.error("Failed to save bot message");

        } catch (err) {
          document.getElementById('loading-bubble')?.remove();
          addChatBubble('⚠️ Gagal menghubungi chatbot.', 'bot');
          console.error(err);
        }
      }

      sendButton.addEventListener('click', sendMessage);
      inputField.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
    </script>

<script>
  let currentChatId = null;

  // Fetch actual user ID from session or authentication context
  function getUserIdFromSession() {
    const userStr = sessionStorage.getItem('user');
    if (!userStr) return null;
    try {
      const user = JSON.parse(userStr);
      return user.id || null;
    } catch {
      return null;
    }
  }
  const userId = getUserIdFromSession();

  async function fetchChatList() {
    try {
      console.log("Fetching chat list for userId:", userId);
      if (!userId) {
        console.error("User ID not found in sessionStorage.");
        document.getElementById('chat-history').innerHTML = '<p class="text-white p-4">User not logged in. Please login again.</p>';
        return;
      }
      const res = await fetch(`http://localhost:8000/chat_history/chats/${userId}`);
      if (!res.ok) {
        console.error("Failed to fetch chat list, status:", res.status);
        throw new Error("Failed to fetch chat list");
      }
      const chats = await res.json();
      console.log("Chat list fetched:", chats);
      renderChatList(chats);
    } catch (error) {
      console.error(error);
      renderChatList([]);
    }
  }

  function renderChatList(chats) {
    const container = document.getElementById('chat-history');
    container.innerHTML = '';
    chats.forEach(chat => {
      const item = document.createElement('div');
      item.className = `p-3 bg-white/10 hover:bg-white/20 rounded-md cursor-pointer transition flex justify-between items-center ${
        chat.id === currentChatId ? 'border border-emerald-400' : ''
      }`;
      item.innerHTML = `<div class="flex flex-col flex-grow cursor-pointer">
          <div class="text-white font-semibold">${chat.title}</div>
          <div class="text-sm text-white/60">${new Date(chat.created_at).toLocaleDateString()}</div>
        </div>
        <button class="text-red-500 hover:text-red-700 ml-4" title="Hapus percakapan">
          <i class="fa-solid fa-trash"></i>
        </button>`;
      const deleteButton = item.querySelector('button');
      deleteButton.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!confirm('Apakah Anda yakin ingin menghapus percakapan ini?')) return;
        try {
          const res = await fetch(`http://localhost:8000/chat_history/chats/${chat.id}`, {
            method: 'DELETE',
          });
          if (!res.ok) throw new Error('Gagal menghapus percakapan');
          if (chat.id === currentChatId) {
            currentChatId = null;
            chatContainer.innerHTML = '';
          }
          fetchChatList();
        } catch (error) {
          alert('Gagal menghapus percakapan. Silakan coba lagi.');
          console.error(error);
        }
      });
      item.onclick = () => loadChat(chat.id);
      container.appendChild(item);
    });
  }

  async function loadChat(chatId) {
    currentChatId = chatId;

    
    // Clear current chat
    chatContainer.innerHTML = '';

    try {
      const res = await fetch(`http://localhost:8000/chat_history/messages/${chatId}`);
      if (!res.ok) throw new Error("Failed to fetch messages");
      const messages = await res.json();
      messages.forEach(msg => addChatBubble(msg.content, msg.sender));
    } catch (error) {
      console.error(error);
      addChatBubble("⚠️ Gagal memuat pesan chat.", "bot");
    }

    fetchChatList(); // Re-render sidebar to highlight current
  }

  // Handle "New Chat"
  document.getElementById('new-chat-btn').addEventListener('click', () => {
    currentChatId = `chat-${Date.now()}`; // Simulasi ID baru
    chatContainer.innerHTML = '';
    fetchChatList();
  });

  // Load on first run
  fetchChatList();
  
</script>

  </body>
</html>
